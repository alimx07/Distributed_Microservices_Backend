name: PUSH IMGAGE DEV

on:
  push:
    branches: [dev]
    paths: ['services/**']

jobs:
  build-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build, push, and update manifests
        run: |
          for svc in api_gateway user_service post_service follow_service feed_service; do
            if git diff --name-only HEAD~1 HEAD | grep -q "^services/${svc}/"; then
              docker build -t alimx07/${svc}:dev -t alimx07/${svc}:dev-${{ github.sha }} services/${svc}
              docker push alimx07/${svc}:dev
              docker push alimx07/${svc}:dev-${{ github.sha }}
              k8s_dir="k8s/$(echo ${svc} | tr '_' '-')"
              sed -i "s|image: alimx07/${svc}:.*|image: alimx07/${svc}:dev-${{ github.sha }}|" ${k8s_dir}/deployment.yaml
            fi
          done

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Services CI: Update dev image to ${{ github.sha }}"
          file_pattern: "k8s/*/deployment.yaml"

